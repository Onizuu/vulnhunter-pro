<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport de S√©curit√© - {{ rapport.titre }}</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
            --info-color: #2980b9;
            --light-gray: #ecf0f1;
            --dark-gray: #7f8c8d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px;
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
        }

        /* Header */
        header {
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 20px;
            margin-bottom: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .report-meta {
            text-align: right;
            font-size: 14px;
            color: var(--dark-gray);
        }

        /* Typography */
        h1,
        h2,
        h3,
        h4 {
            color: var(--primary-color);
        }

        h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        h2 {
            font-size: 24px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 40px;
        }

        h3 {
            font-size: 18px;
            color: var(--secondary-color);
            margin-top: 25px;
        }

        /* Executive Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-top: 4px solid var(--accent-color);
        }

        .card.critical {
            border-color: var(--danger-color);
        }

        .card.high {
            border-color: var(--warning-color);
        }

        .card.medium {
            border-color: var(--info-color);
        }

        .card.low {
            border-color: var(--success-color);
        }

        .card-number {
            font-size: 36px;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .card-label {
            font-size: 14px;
            color: var(--dark-gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Charts Section */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        /* Vulnerability Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: var(--light-gray);
            color: var(--secondary-color);
            font-weight: 600;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }

        .badge-critical {
            background-color: var(--danger-color);
        }

        .badge-high {
            background-color: var(--warning-color);
        }

        .badge-medium {
            background-color: var(--info-color);
        }

        .badge-low {
            background-color: var(--success-color);
        }

        /* Detailed Findings */
        .finding {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            page-break-inside: avoid;
        }

        .finding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .finding-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .finding-details {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            font-size: 14px;
        }

        .label {
            font-weight: bold;
            color: var(--dark-gray);
        }

        .code-block {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            overflow-x: auto;
            margin-top: 5px;
            font-size: 12px;
        }

        /* Footer */
        footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            text-align: center;
            font-size: 12px;
            color: var(--dark-gray);
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .container {
                width: 100%;
                max-width: none;
                padding: 0;
                box-shadow: none;
            }

            .no-print {
                display: none;
            }

            h2 {
                page-break-before: always;
            }

            h2:first-of-type {
                page-break-before: avoid;
            }

            a {
                text-decoration: none;
                color: black;
            }
        }
    </style>
    <!-- Chart.js for rendering charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">üõ°Ô∏è VulnHunter Pro</div>
            <div class="report-meta">
                <div><strong>Rapport ID:</strong> {{ rapport.id_rapport }}</div>
                <div><strong>Date:</strong> {{ rapport.date_generation.strftime('%d/%m/%Y %H:%M') }}</div>
                <div><strong>Cible:</strong> {{ rapport.url_cible }}</div>
            </div>
        </header>

        <div class="no-print" style="text-align: right; margin-bottom: 20px;">
            <button onclick="window.print()"
                style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">üñ®Ô∏è
                Imprimer / PDF</button>
        </div>

        <h1>Rapport Ex√©cutif de S√©curit√©</h1>
        <p>Ce rapport pr√©sente une analyse d√©taill√©e des vuln√©rabilit√©s d√©tect√©es lors du scan de s√©curit√© automatis√©.
        </p>

        <!-- Executive Summary -->
        <h2>1. R√©sum√© Ex√©cutif</h2>
        <div class="summary-grid">
            <div class="card critical">
                <span class="card-number" style="color: var(--danger-color)">{{
                    rapport.metriques_cle.distribution_severite.get('CRITIQUE', 0) }}</span>
                <span class="card-label">Critiques</span>
            </div>
            <div class="card high">
                <span class="card-number" style="color: var(--warning-color)">{{
                    rapport.metriques_cle.distribution_severite.get('√âLEV√â', 0) }}</span>
                <span class="card-label">√âlev√©es</span>
            </div>
            <div class="card medium">
                <span class="card-number" style="color: var(--info-color)">{{
                    rapport.metriques_cle.distribution_severite.get('MOYEN', 0) }}</span>
                <span class="card-label">Moyennes</span>
            </div>
            <div class="card low">
                <span class="card-number" style="color: var(--success-color)">{{
                    rapport.metriques_cle.distribution_severite.get('FAIBLE', 0) }}</span>
                <span class="card-label">Faibles</span>
            </div>
        </div>

        <div
            style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid var(--primary-color);">
            <h3>Analyse Globale</h3>
            <p>{{ rapport.resume_executif.situation_generale }}</p>
            <p><strong>Score de Risque Global:</strong> {{ "%.1f"|format(rapport.metriques_cle.score_risque_global)
                }}/100</p>
        </div>

        <!-- Charts -->
        <h2>2. Analyse Visuelle</h2>
        <div class="charts-container">
            <div class="chart-box">
                <canvas id="severityChart"></canvas>
            </div>
            <div class="chart-box">
                <canvas id="typeChart"></canvas>
            </div>
        </div>

        <!-- Critical Risks -->
        {% if rapport.risques_critiques %}
        <h2>3. Risques Critiques Identifi√©s</h2>
        <p>Les vuln√©rabilit√©s suivantes n√©cessitent une attention imm√©diate :</p>
        <table>
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Impact</th>
                    <th>Localisation</th>
                    <th>Urgence</th>
                </tr>
            </thead>
            <tbody>
                {% for risque in rapport.risques_critiques %}
                <tr>
                    <td><strong>{{ risque.description }}</strong></td>
                    <td>{{ risque.impact }}</td>
                    <td style="font-family: monospace; font-size: 12px;">{{ risque.localisation }}</td>
                    <td><span class="badge badge-critical">{{ risque.urgence }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}

        <!-- Detailed Findings -->
        <h2>4. D√©tails des Vuln√©rabilit√©s</h2>
        {% for vuln in rapport.vulnerabilites %}
        <div class="finding">
            <div class="finding-header">
                <div class="finding-title">{{ vuln.type }}</div>
                <span
                    class="badge badge-{{ vuln.severite|lower if vuln.severite in ['CRITIQUE', '√âLEV√â', 'MOYEN', 'FAIBLE'] else 'low' }}">{{
                    vuln.severite }}</span>
            </div>
            <div class="finding-details">
                <div class="label">URL:</div>
                <div style="word-break: break-all;">{{ vuln.url }}</div>

                <div class="label">Description:</div>
                <div>{{ vuln.description }}</div>

                {% if vuln.payload %}
                <div class="label">Payload:</div>
                <div class="code-block">{{ vuln.payload }}</div>
                {% endif %}

                {% if vuln.remediation %}
                <div class="label">Rem√©diation:</div>
                <div>{{ vuln.remediation }}</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- Recommendations -->
        <h2>5. Recommandations Strat√©giques</h2>
        <ul>
            {% for rec in rapport.recommandations_prioritaires %}
            <li style="margin-bottom: 10px;">
                <strong>{{ rec.action }}</strong> (Priorit√©: {{ rec.priorite }})
                <br><span style="color: var(--dark-gray); font-size: 14px;">Impact: {{ rec.impact }}</span>
            </li>
            {% endfor %}
        </ul>

        <footer>
            <p>G√©n√©r√© par VulnHunter Pro - {{ rapport.date_generation.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </footer>
    </div>

    <!-- Data for Charts (rendered by Jinja2) -->
    <script type="application/json" id="reportData">
        {
            "severity": {
                "critique": {{ rapport.metriques_cle.distribution_severite.get('CRITIQUE', 0) }},
                "eleve": {{ rapport.metriques_cle.distribution_severite.get('√âLEV√â', 0) }},
                "moyen": {{ rapport.metriques_cle.distribution_severite.get('MOYEN', 0) }},
                "faible": {{ rapport.metriques_cle.distribution_severite.get('FAIBLE', 0) }}
            },
            "topTypes": {{ rapport.metriques_cle.top_types|tojson|safe }}
        }
    </script>

    <script>
        // Parse report data
        const reportData = JSON.parse(document.getElementById('reportData').textContent);

        // Render Severity Chart
        const severityCtx = document.getElementById('severityChart').getContext('2d');
        new Chart(severityCtx, {
            type: 'doughnut',
            data: {
                labels: ['Critique', '√âlev√©e', 'Moyenne', 'Faible'],
                datasets: [{
                    data: [
                        reportData.severity.critique,
                        reportData.severity.eleve,
                        reportData.severity.moyen,
                        reportData.severity.faible
                    ],
                    backgroundColor: ['#e74c3c', '#f39c12', '#2980b9', '#27ae60']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Distribution par S√©v√©rit√©' },
                    legend: { position: 'bottom' }
                }
            }
        });

        // Render Type Chart
        const typeCtx = document.getElementById('typeChart').getContext('2d');
        const topTypes = reportData.topTypes || [];
        const typeLabels = [];
        const typeCounts = [];

        for (let i = 0; i < topTypes.length; i++) {
            typeLabels.push(topTypes[i].type);
            typeCounts.push(topTypes[i].count);
        }

        new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: typeLabels,
                datasets: [{
                    label: 'Nombre de vuln√©rabilit√©s',
                    data: typeCounts,
                    backgroundColor: '#34495e'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Top 5 Types de Vuln√©rabilit√©s' },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
    </script>
</body>

</html>
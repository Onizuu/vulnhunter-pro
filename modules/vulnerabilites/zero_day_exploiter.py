"""
Module d'exploitation automatique des vuln√©rabilit√©s 0-day
Utilise l'IA pour g√©n√©rer des exploits personnalis√©s
"""

import asyncio
from typing import List, Optional, Dict
from loguru import logger
import aiohttp

from core.models import Vulnerabilite


class ExploiteurZeroDay:
    """
    Exploite automatiquement les vuln√©rabilit√©s 0-day d√©tect√©es
    Utilise l'IA pour g√©n√©rer des exploits personnalis√©s
    """

    def __init__(self, client_ia):
        """
        Initialise l'exploiteur 0-day
        
        Args:
            client_ia: Client IA pour g√©n√©ration d'exploits
        """
        self.client_ia = client_ia

    async def exploiter_zeroday(self, vulnerabilite: Vulnerabilite) -> Optional[str]:
        """
        G√©n√®re et teste un exploit pour une vuln√©rabilit√© 0-day
        
        Args:
            vulnerabilite: Vuln√©rabilit√© 0-day √† exploiter
            
        Returns:
            str: Code de l'exploit g√©n√©r√© ou None
        """
        if not self.client_ia or not self.client_ia.disponible:
            logger.warning("IA non disponible pour g√©n√©ration d'exploit 0-day")
            return None

        try:
            logger.info(f"ü§ñ G√©n√©ration d'exploit 0-day pour {vulnerabilite.type}")
            
            # G√©n√©rer l'exploit avec l'IA
            exploit = await self._generer_exploit_ia(vulnerabilite)
            
            if exploit:
                logger.success(f"‚úÖ Exploit 0-day g√©n√©r√© pour {vulnerabilite.type}")
                vulnerabilite.exploit_code = exploit
                return exploit
            
            return None
            
        except Exception as e:
            logger.error(f"Erreur g√©n√©ration exploit 0-day: {str(e)}")
            return None

    async def _generer_exploit_ia(self, vuln: Vulnerabilite) -> Optional[str]:
        """
        G√©n√®re un exploit personnalis√© avec l'IA
        
        Args:
            vuln: Vuln√©rabilit√©
            
        Returns:
            str: Code de l'exploit
        """
        prompt = f"""G√©n√®re un exploit Python complet et fonctionnel pour cette vuln√©rabilit√© 0-day:

Type: {vuln.type}
URL: {vuln.url}
Description: {vuln.description}
Payload: {vuln.payload or 'Aucun payload sp√©cifique'}
Preuve: {vuln.preuve or 'Aucune preuve'}

L'exploit doit:
1. √ätre un script Python 3 standalone et fonctionnel
2. Tester r√©ellement la vuln√©rabilit√© sur l'URL fournie
3. Inclure des commentaires d√©taill√©s en fran√ßais
4. G√©rer les erreurs proprement
5. Afficher des messages informatifs
6. √ätre s√ªr et non destructif (mode test)
7. Inclure une fonction main() avec gestion d'arguments
8. Utiliser les biblioth√®ques requests ou aiohttp
9. Tester plusieurs techniques d'exploitation
10. Fournir une preuve d'exploitation r√©ussie

Techniques √† utiliser selon le type:
- Injection SQL: UNION, erreurs, temporel, bool√©en
- XSS: R√©flexion, DOM-based, stock√©
- RCE: Commandes syst√®me, webshell, reverse shell
- XXE: Lecture fichiers, SSRF, DoS
- IDOR: Acc√®s non autoris√©, √©num√©ration
- CORS: Acc√®s cross-origin, credentials

Retourne UNIQUEMENT le code Python complet, sans explications ni markdown."""

        try:
            exploit = await self.client_ia.generer_completion(prompt)
            
            if exploit:
                # Nettoyer le code (enlever markdown si pr√©sent)
                exploit = exploit.strip()
                if exploit.startswith('```python'):
                    exploit = exploit[9:]
                if exploit.startswith('```'):
                    exploit = exploit[3:]
                if exploit.endswith('```'):
                    exploit = exploit[:-3]
                exploit = exploit.strip()
                
                return exploit
            
            return None
            
        except Exception as e:
            logger.error(f"Erreur g√©n√©ration exploit IA: {str(e)}")
            return None

